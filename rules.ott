defns
Ty :: '' ::=

defn
G â—¡ D â«¦ e :: :: Ty_eff :: Ty_eff_ {{ com Typing of effects (require both positive and negative contexts) }} by

-------------- :: N
{} â—¡ {} â«¦ Îµ

G â—¡ D â«¦ w : T  [[:TYw]]
{{ ctx_Disjoint [[P G]] [[P {@h : m nâŒŠTâŒ‹}]] }}
{{ ctx_Disjoint [[P G]] [[N D]] }}
{{ ctx_Disjoint [[P {@h : m nâŒŠTâŒ‹}]] [[N D]] }}
------------------- :: A
(Â¹â†‘Â·mÂ·n)Â·G âˆª {@h : m nâŒŠTâŒ‹} â—¡ (mÂ·n)Â·D â«¦ h â‰” w

G1 â—¡ D1 âˆª -G22 â«¦ e1 [[:TYe1]]
G21 âˆª G22 â—¡ D2 â«¦ e2 [[:TYe2]]
{{ pctx_DestOnly [[G22]] }}
{{ ctx_Disjoint [[P G1]] [[P G21]] }}
{{ ctx_Disjoint [[P G1]] [[P G22]] }}
{{ ctx_Disjoint [[P G1]] [[N D1]] }}
{{ ctx_Disjoint [[P G1]] [[N D2]] }}
{{ ctx_Disjoint [[P G21]] [[P G22]] }}
{{ ctx_Disjoint [[P G21]] [[N D1]] }}
{{ ctx_Disjoint [[P G21]] [[N D2]] }}
{{ ctx_Disjoint [[P G22]] [[N D1]] }}
{{ ctx_Disjoint [[P G22]] [[N D2]] }}
{{ ctx_Disjoint [[N D1]] [[N D2]] }}
------------------------- :: P
G1 âˆª G21 â—¡ D1 âˆª D2 â«¦ e1 Â» e2

defn
G âŠ¢ v â‹„ e : T :: :: Ty_cmd :: Ty_cmd_ {{ com Typing of commands (only a positive context is needed) }} by

G11 âˆª G12 âŠ¢ v : T [[:TYv]]
G2 â—¡ -G12 â«¦ e [[:TYe]]
{{ pctx_DestOnly [[G12]] }}
{{ ctx_Disjoint [[P G11]] [[P G12]] }}
{{ ctx_Disjoint [[P G11]] [[P G2]] }}
{{ ctx_Disjoint [[P G12]] [[P G2]] }}
------------------ :: C
G11 âˆª G2 âŠ¢ v â‹„ e : T


defn
G â—¡ D â«¦ w : T :: :: Ty_xval :: Ty_xval_ {{ com Typing of extended values (require both positive and negative contexts) }} by

--------------------- :: H
{} â—¡ { h : Â¹Î½ T } â«¦ h : T

---------------- :: D
{ @h : Â¹Î½ nâŒŠTâŒ‹ } â—¡ {} â«¦ @h : nâŒŠTâŒ‹

--------------------- :: U
{} â—¡ {} â«¦ () :ğŸ

G â—¡ D â«¦ w : T1 [[:TYw]]
{{ ctx_Disjoint [[P G]] [[N D]] }}
--------------------- :: L
G â—¡ D â«¦ Inl w : T1 â¨ T2

G â—¡ D â«¦ w : T2 [[:TYw]]
{{ ctx_Disjoint [[P G]] [[N D]] }}
--------------------- :: R
G â—¡ D â«¦ Inr w : T1 â¨ T2

G1 â—¡ D1 â«¦ w1 : T1 [[:TYw1]]
G2 â—¡ D2 â«¦ w2 : T2 [[:TYw2]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
{{ ctx_Disjoint [[P G1]] [[N D1]] }}
{{ ctx_Disjoint [[P G1]] [[N D2]] }}
{{ ctx_Disjoint [[P G2]] [[N D1]] }}
{{ ctx_Disjoint [[P G2]] [[N D2]] }}
{{ ctx_Disjoint [[N D1]] [[N D2]] }}
------------------------- :: P
G1 âˆª G2 â—¡ D1 âˆª D2 â«¦ (w1, w2) : T1 â¨‚ T2

% TODO: should we augment age of holes which are below an exponential?
% TODO: yes so that they match their destination mode?
G â—¡ D â«¦ w : T [[:TYw]]
{{ ctx_Disjoint [[P G]] [[N D]] }}
--------------------- :: E
mÂ·G â—¡ mÂ·D â«¦ â¦† m w : ! m T

G1 â—¡ {} â«¦ v1 : T1 [[:TYv1X]]
G2 â—¡ -G1 â«¦ w2 : T2 [[:TYw2]]
{{ pctx_DestOnly [[G1]] }}
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
---------------- :: A
G2 â—¡ {} â«¦ âŸ¨v1 âŸ w2âŸ© -G1 : T1 â§• T2

G âˆª { x : m T1 } âŠ¢ t : T2 [[:TYt]]
{{ ctx_Disjoint [[P G]] [[P { x : m T1 }]] }}
----------------- :: F
G â—¡ {} â«¦ Î»x âŸ¼ t : T1 m â†’ T2

defn
G âŠ¢ t : T :: :: Ty_term :: Ty_term_ {{ com Typing of terms (only a positive context is needed) }} by

G â—¡ {} â«¦ v : T [[:TYvX]]
----------------- :: V
G âŠ¢ v : T

-------------------- :: X0
{ x : Â¹Î½ T } âŠ¢ x : T

-------------------- :: XInf
{ x : Â¹âˆ T } âŠ¢ x : T

G1 âŠ¢ t : T1 [[:TYt]]
G2 âŠ¢ u : T1 m â†’ T2 [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
----------------- :: App
mÂ·G1 âˆª G2 âŠ¢ t â‰» u : T2

G1 âŠ¢ t :ğŸ [[:TYt]]
G2 âŠ¢ u : U [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
----------------- :: PatU
G1 âˆª G2 âŠ¢ t ; u : U

G1 âŠ¢ t : T1 â¨ T2 [[:TYt]]
G2 âˆª { x1 : m T1 } âŠ¢ u1 : U [[:TYu1]]
G2 âˆª { x2 : m T2 } âŠ¢ u2 : U [[:TYu2]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
{{ ctx_Disjoint [[P G2]] [[P { x1 : m T1 }]] }}
{{ ctx_Disjoint [[P G2]] [[P { x2 : m T2 }]] }}
----------------- :: PatS
mÂ·G1 âˆª G2 âŠ¢ t â‰»case { Inl x1 âŸ¼ u1 , Inr x2 âŸ¼ u2 } : U

G1 âŠ¢ t : T1 â¨‚ T2 [[:TYt]]
G2 âˆª { x1 : m T1, x2 : m T2 } âŠ¢ u : U [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
{{ ctx_Disjoint [[P G2]] [[P { x1 : m T1}]] }}
{{ ctx_Disjoint [[P G2]] [[P { x2 : m T2}]] }}
{{ ctx_Disjoint [[P {x1 : m T1}]] [[P {x2 : m T2}]] }}
----------------- :: PatP
mÂ·G1 âˆª G2 âŠ¢ t â‰»case (x1 , x2) âŸ¼ u : U

G1 âŠ¢ t : !n T [[:TYt]]
G2 âˆª { x : mÂ·n T } âŠ¢ u : U [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
{{ ctx_Disjoint [[P G2]] [[P { x : mÂ·n T }]] }}
----------------- :: PatE
mÂ·G1 âˆª G2 âŠ¢ t â‰»case â¦† n x âŸ¼ u : U

G1 âŠ¢ t : T1 â§• T2 [[:TYt]]
Â¹â†‘Â·G2 âˆª { x : Â¹Î½ T1 } âŠ¢ u : U [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
{{ ctx_Disjoint [[P G2]] [[P { x : Â¹Î½ T1 }]] }}
-------------------------------- :: Map
G1 âˆª G2 âŠ¢ t â‰»map x âŸ¼ u : U â§• T2

G1 âŠ¢ t : nâŒŠT2âŒ‹ [[:TYt]]
G2 âŠ¢ u : T1 â§• T2 [[:TYu]]
{{ ctx_Disjoint [[P G1]] [[P G2]] }}
----------------------------- :: FillC
G1 âˆª (Â¹â†‘Â·n)Â·G2 âŠ¢ t â¨Â· u : T1

G âŠ¢ t : nâŒŠğŸâŒ‹ [[:TYt]]
------------------------------ :: FillU
G âŠ¢ t â¨ () :ğŸ

G âŠ¢ t : nâŒŠT1 â¨ T2âŒ‹ [[:TYt]]
------------------------------ :: FillL
G âŠ¢ t â¨ Inl : nâŒŠT1âŒ‹

G âŠ¢ t : nâŒŠT1 â¨ T2âŒ‹ [[:TYt]]
------------------------------ :: FillR
G âŠ¢ t â¨ Inr : nâŒŠT2âŒ‹

G âŠ¢ t : nâŒŠT1 â¨‚ T2âŒ‹ [[:TYt]]
------------------------------ :: FillP
G âŠ¢ t â¨ (,) : nâŒŠT1âŒ‹ â¨‚ nâŒŠT2âŒ‹

G âŠ¢ t : mâŒŠ!n TâŒ‹ [[:TYt]]
------------------------------ :: FillE
G âŠ¢ t â¨ â¦† n : mÂ·nâŒŠTâŒ‹

-------------------------------- :: Alloc
{} âŠ¢ alloc T : Â¹Î½âŒŠTâŒ‹ â§• T

G âŠ¢ t : T [[:TYt]]
------------------------------- :: ToA
G âŠ¢ toâ§• t : ğŸ â§• T

G âŠ¢ t : ğŸ â§• T [[:TYt]]
------------------------------- :: FromA
G âŠ¢ fromâ§• t : T

defns
Sem :: '' ::=

defn
w1 D1 | e1 â¤‹ w2 D2 | e2 :: :: Sem_eff :: Sem_eff_ {{ com Big-step evaluation of effects on extended values }} {{ tex [[w1]]_{~[[D1]]}\,|~[[e1]]~~[[â¤‹]]~~[[w2]]_{~[[D2]]}\,|~[[e2]] }} by

------------------------- :: N
w1 D1 | Îµ â¤‹ w1 D1 | Îµ

% G2 â—¡ D2 â«¦ w2 : T
% {{ ctx_Disjoint [[P G']] [[-D]] }}
{{ ctx_HvarNotMem [[h]] [[N D1]] }}
w1 D1 |e1 â¤‹ w2 D2| e2 [[:EAPPw1e1]]
--------------------- :: S
w1 D1 | h â‰” w' Â» e1 â¤‹ w2 D2 | h â‰” w' Â» e2

G0 â—¡ D0 â«¦ w0 : T [[:TYw0]]
{{ ctx_Disjoint [[P G0]] [[N D0]] }}
{{ ctx_Disjoint [[N D1]] [[N { h : n T }]] }}
{{ ctx_Disjoint [[N D1]] [[N D0]] }}
w1[h â‰” w0] (D1 âˆª nÂ·D0) | e1 â¤‹ w2 D2 | e2 [[:EAPPw1sube1]]
--------------------- :: F
w1 D1 âˆª { h : n T } | h â‰” w0 Â» e1 â¤‹ w2 D2 | e2

% eff_app1 = eff_app2 :: :: EffApp :: EffApp_ {{ com $[[apply]]$: how effects are applied locally or winded up (we assume effect lists are $\ottseff{\varepsilon}$-terminated) }} by

% ------------- :: NoEff
% apply (Îµ, w D) = Îµ , w D

% % Those two conditions ensures that no destination escapes its inner scope
% % TODO Should we put them there?


% % ------------------ :: FillUnit
% % apply(h â‰” (), e, w D âˆª { -h : Â¹Î½ 1 }) = apply(e , w[h â‰” ()] D)

% % ------------------ :: FillInl
% % apply(h â‰” Inl h', e, w D âˆª { -h : Â¹Î½ T1 â¨ T2 }) = apply(e , w[h â‰” Inl h'] D âˆª {-h' : Â¹Î½ T1})

% % ------------------ :: FillInr
% % apply(h â‰” Inr h', e, w D âˆª { -h : Â¹Î½ T1 â¨ T2 }) = apply(e , w[h â‰” Inr h'] D âˆª {-h' : Â¹Î½ T2})
% % ------------------ :: FillProd
% % apply(h â‰” (h1, h2), e, w D âˆª { -h : Â¹Î½ T1 â¨‚ T2 }) = apply(e , w[h â‰” (h1, h2)] D âˆª {-h1 : Â¹Î½ T1, -h2 : Â¹Î½ T2})


defn
t â‡“ v â‹„ e :: :: Sem_term :: Sem_term_ {{ com Big-step evaluation into commands }} by

------------------ :: V
v â‡“ v â‹„ Îµ

t1 â‡“ v1 â‹„ e1 [[:REDt1]]
t2 â‡“ Î»x âŸ¼ u â‹„ e2 [[:REDt2]]
u[x â‰” v1] â‡“ v3 â‹„ e3 [[:REDusub]]
------------------ :: App
t1 â‰» t2 â‡“ v3 â‹„ e1 Â» e2 Â» e3

t1 â‡“ () â‹„ e1 [[:REDt1]]
t2 â‡“ v2 â‹„ e2 [[:REDt2]]
----------------------- :: PatU
t1 ; t2 â‡“ v2 â‹„ e1 Â» e2

t â‡“ Inl v1 â‹„ e1 [[:REDt]]
u1[x1 â‰” v1] â‡“ v2 â‹„ e2 [[:REDu1sub]]
----------------------- :: PatL
t â‰»case { Inl x1 âŸ¼ u1, Inr x2 âŸ¼ u2 } â‡“ v2 â‹„ e1 Â» e2

t â‡“ Inr v1 â‹„ e1 [[:REDt]]
u2[x2 â‰” v1] â‡“ v2 â‹„ e2 [[:REDu2sub]]
----------------------- :: PatR
t â‰»case { Inl x1 âŸ¼ u1, Inr x2 âŸ¼ u2 } â‡“ v2 â‹„ e1 Â» e2

t â‡“ (v1,v2) â‹„ e1 [[:REDt]]
u[x1 â‰” v1][x2 â‰” v2] â‡“ v2 â‹„ e2 [[:REDusub]]
----------------------- :: PatP
t â‰»case (x1,x2) âŸ¼ u â‡“ v2 â‹„ e1 Â» e2

% Can e1 have effect on the content of the ampar? I don't think so, but maybe
t â‡“ âŸ¨ v1 âŸ w2 âŸ© D â‹„ e1 [[:REDt]]
u[x â‰” v1] â‡“ v3 â‹„ e2 [[:REDusub]]
 w2 D |e2 â¤‹ w4 D'| e3 [[:EAPPw2e2]]
---------------------------------- :: Map
t â‰»map x âŸ¼ u â‡“ âŸ¨v3 âŸ w4âŸ© D' â‹„ e1 Â» e3

{{ hvar_Fresh [[h]] }}
-------------------------- :: Alloc
alloc T â‡“ âŸ¨ @h âŸ h âŸ© { h : Â¹Î½ T } â‹„ Îµ

t â‡“ v â‹„ e [[:REDt]]
----------------------------------------- :: ToA
toâ§• t â‡“ âŸ¨ () âŸ v âŸ© {} â‹„ e

t â‡“ âŸ¨ () âŸ v âŸ© {} â‹„ e [[:REDt]]
-------------------------------------- :: FromA
fromâ§• t â‡“ v â‹„ e

t â‡“ @h â‹„ e [[:REDt]]
------------------------------------- :: FillU
t â¨ () â‡“ () â‹„ e Â» h â‰” ()

t â‡“ @h â‹„ e [[:REDt]]
{{ hvar_Fresh [[h']] }}
--------------------------------------- :: FillL
t â¨ Inl â‡“ @h' â‹„ e Â» h â‰” Inl h'

t â‡“ @h â‹„ e [[:REDt]]
--------------------------------------- :: FillR
t â¨ Inr â‡“ @h' â‹„ e Â» h â‰” Inr h'

t â‡“ @h â‹„ e [[:REDt]]
{{ hvar_Fresh [[h1]] }}
{{ hvar_Fresh [[h2]] }}
--------------------------------------- :: FillP
t â¨ (,) â‡“ (@h1, @h2) â‹„ e Â» h â‰” (h1,h2)

t â‡“ @h â‹„ e1 [[:REDt]]
u â‡“ âŸ¨v1 âŸ w2âŸ© D â‹„ e2 [[:REDu]]
---------------------------------------- :: FillC
t â¨Â· u â‡“ v1â‹„ e1 Â» e2 Â» h â‰” w2
