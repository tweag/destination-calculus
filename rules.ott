defns
Ty :: '' ::=

defn
G â«¦ e :: :: TyR_eff :: TyR_eff_ {{ com Typing of effects (raw) }} by

-------------- :: N
{} â«¦ Îµ

G â¨„ D â«¦ v : T [[:TYRv]]
{{ ctx_DestOnly [[G]] }}
{{ ctx_HoleOnly [[D]] }}
------------------- :: A
(Â¹â†‘Â·mÂ·n)Â·G â¨„ {+h : m âŒŠTâŒ‹n} â¨„ (mÂ·n)Â·D â«¦ h â‰” v

G1 â«¦ e1 [[:TYRe1]]
G2 â«¦ e2 [[:TYRe2]]
------------------------- :: C
G1 â»â¨„âº G2 â«¦ e1 Â» e2

defn
G âŠ¢ e :: :: Ty_eff :: Ty_eff_ {{ com Typing of effects (valid ones only) }} by

G â«¦ e [[:TYRe]]
{{ ctx_Valid [[G]] }}
----------------------- :: T
G âŠ¢ e

defn
G â«¦ t : T :: :: TyR_term :: TyR_term_ {{ com Typing of terms (raw) }} by

--------------------- :: H
{ - h : Â¹Î½ T } â«¦ -h : T

---------------- :: D
{ +h : Â¹Î½ âŒŠTâŒ‹n } â«¦ +h : âŒŠTâŒ‹n

--------------------- :: U
{} â«¦ () :ğŸ

G â«¦ v : T1 [[:TYRv]]
--------------------- :: L
G â«¦ Inl v : T1 â¨ T2

G â«¦ v : T2 [[:TYRv]]
--------------------- :: R
G â«¦ Inr v : T1 â¨ T2

G1 â«¦ v1 : T1 [[:TYRv1]]
G2 â«¦ v2 : T2 [[:TYRv2]]
------------------------- :: P
G1 â¨„ G2 â«¦ (v1, v2) : T1 â¨‚ T2

% TODO: should we augment age of holes which are below an exponential?
% TODO: yes so that they match their destination mode?
G â«¦ v : T [[:TYRv]]
--------------------- :: E
mÂ·G â«¦ â¦† m v : ! m T

% We perform controls here on Ampar, and not on the other rules, because outside of the ampar, the hole/dests that are compensated will no longer be visible.
% {{ ctx_DestOnly [[G1 â»â¨„âº G2]] }} % ensures that every hole of G1 is compensated by a dest in G2 --> we might relax this one, and ensure it later in Ty_term (not raw)
G1 â«¦ v1 : T1 [[:TYRv1]]
G2 â«¦ v2 : T2 [[:TYRv2]]
{{ ctx_DestOnly [[G2]] }} % ensures that there is no hole in G2 (that could be compensated by a dest in G1 and not appear in the final context). --> no longer need that with one-sided compensation, but needed for using -G2
{{ ctx_SubsetEq [[-G2]] [[G1]] }} % ensures that every dest of G2 is from this ampar, not a stored dest (our system is supposed to restrict storing dests from other ampars in the right side). So we know that holes of this ampar are exactly -G2.
---------------- :: A
G1 â»â¨„âº G2 â«¦ âŸ¨v1 âŸ v2âŸ© -G1 : T1 â§” T2

G â¨„ { x : m T1 } â«¦ t : T2 [[:TYRt]]
----------------- :: F
G â«¦ Î»x âŸ¼ t : T1 m â†’ T2

{{ ctx_Compatible [[G]] [[{ x : Â¹Î½ T }]] }}
-------------------- :: Var
G â«¦ x : T

G1 â«¦ t : T1 [[:TYRt]]
G2 â«¦ u : T1 m â†’ T2 [[:TYRu]]
----------------- :: App
mÂ·G1 â¨„ G2 â«¦ t â‰» u : T2

G1 â«¦ t :ğŸ [[:TYRt]]
G2 â«¦ u : U [[:TYRu]]
----------------- :: PatU
G1 â¨„ G2 â«¦ t ; u : U

G1 â«¦ t : T1 â¨ T2 [[:TYRt]]
G2 â¨„ { x1 : m T1 } â«¦ u1 : U [[:TYRu1]]
G2 â¨„ { x2 : m T2 } â«¦ u2 : U [[:TYRu2]]
----------------- :: PatS
mÂ·G1 â¨„ G2 â«¦ t â‰»case { Inl x1 âŸ¼ u1 , Inr x2 âŸ¼ u2 } : U

G1 â«¦ t : T1 â¨‚ T2 [[:TYRt]]
G2 â¨„ { x1 : m T1, x2 : m T2 } â«¦ u : U [[:TYRu]]
----------------- :: PatP
mÂ·G1 â¨„ G2 â«¦ t â‰»case (x1 , x2) âŸ¼ u : U

G1 â«¦ t : !n T [[:TYRt]]
G2 â¨„ { x : mÂ·n T } â«¦ u : U [[:TYRu]]
----------------- :: PatE
mÂ·G1 â¨„ G2 â«¦ t â‰»case â¦† n x âŸ¼ u : U

G1 â«¦ t : T1 â§” T2 [[:TYRt]]
Â¹â†‘Â·G2 â¨„ { x : Â¹Î½ T2 } â«¦ u : U [[:TYRu]]
-------------------------------- :: Map
G1 â¨„ G2 â«¦ t â‰»map x âŸ¼ u : T1 â§” U

G1 â«¦ t : âŒŠT1âŒ‹n [[:TYRt]]
G2 â«¦ u : T1 â§” T2 [[:TYRu]]
----------------------------- :: FillC
G1 â¨„ (Â¹â†‘Â·n)Â·G2 â«¦ t â¨Â· u : T2

G â«¦ t : âŒŠğŸâŒ‹n [[:TYRt]]
------------------------------ :: FillU
G â«¦ t â¨ () :ğŸ

G â«¦ t : âŒŠT1 â¨ T2âŒ‹n [[:TYRt]]
------------------------------ :: FillL
G â«¦ t â¨ Inl : âŒŠT1âŒ‹n

G â«¦ t : âŒŠT1 â¨ T2âŒ‹n [[:TYRt]]
------------------------------ :: FillR
G â«¦ t â¨ Inr : âŒŠT2âŒ‹n

G â«¦ t : âŒŠT1 â¨‚ T2âŒ‹n [[:TYRt]]
------------------------------ :: FillP
G â«¦ t â¨ (,) : âŒŠT1âŒ‹n â¨‚ âŒŠT2âŒ‹n

G â«¦ t : âŒŠ!n TâŒ‹m [[:TYRt]]
------------------------------ :: FillE
G â«¦ t â¨ â¦† n : âŒŠTâŒ‹mÂ·n

-------------------------------- :: Alloc
{} â«¦ alloc T : T â§” âŒŠTâŒ‹Â¹Î½

G â«¦ t : T [[:TYRt]]
------------------------------- :: ToA
G â«¦ toâ§” t : T â§” ğŸ

G â«¦ t : T â§” ğŸ [[:TYRt]]
------------------------------- :: FromA
G â«¦ fromâ§” t : T

defn
G âŠ¢ t : T :: :: Ty_term :: Ty_term_ {{ com Typing of terms (valid ones only) }} by

G â«¦ t : T [[:TYRt]]
{{ ctx_Valid [[G]] }}
{{ ctx_NoHole [[G]] }}
--------------------- :: T
G âŠ¢ t : T

defn
G âŠ¢ v â‹„ e : T :: :: Ty_cmd :: Ty_cmd_ {{ com Typing of commands (valid ones only) }} by

G1 âŠ¢ e [[:TYe]]
G2 âŠ¢ v : T [[:TYv]]
{{ ctx_DestOnly [[G1 â»â¨„âº G2]] }}
------------------ :: C
G1 â»â¨„âº G2 âŠ¢ v â‹„ e : T

defns
Sem :: '' ::=

defn
v1 G1 | e1 â¤‹ v2 G2 | e2 :: :: Sem_eff :: Sem_eff_ {{ com Big-step evaluation of effects on values (with potential holes) }} {{ tex [[v1]]_{~[[G1]]}\,|~[[e1]]~~[[â¤‹]]~~[[v2]]_{~[[G2]]}\,|~[[e2]] }} by

------------------------- :: N
v1 G1 | Îµ â¤‹ v1 G1 | Îµ

{{ ctx_HdnmNotMem [[h]] [[G1]] }}
v1 G1 |e1 â¤‹ v2 G2| e2 [[:EAPPv1e1]]
--------------------- :: S
v1 G1 | h â‰” v' Â» e1 â¤‹ v2 G2 | h â‰” v' Â» e2

G0 â«¦ v0 : T [[:TYRv0]]
{{ ctx_Valid [[G0]] }} % we don't use simple turnstile here, because we want to allow holes
v1[h â‰” v0] (G1 â¨„ nÂ·G0) | e1 â¤‹ v2 G2 | e2 [[:EAPPv1sube1]]
--------------------- :: F
v1 G1 â¨„ { -h : n T } | h â‰” v0 Â» e1 â¤‹ v2 G2 | e2

defn
t d â‡“ v â‹„ e :: :: Sem_term :: Sem_term_ {{ com Big-step evaluation into commands }} {{ tex [[t]]~_{\scriptscriptstyle[[d]]\!\!\!\!\!}[[â‡“]][[v]][[â‹„]][[e]] }} by

------------------ :: V
v d â‡“ v â‹„ Îµ

t1 d.1 â‡“ v1 â‹„ e1 [[:REDt1]]
t2 d.2 â‡“ Î»x âŸ¼ u â‹„ e2 [[:REDt2]]
u[x â‰” v1] d.3 â‡“ v3 â‹„ e3 [[:REDusub]]
------------------ :: App
t1 â‰» t2 d â‡“ v3 â‹„ e1 Â» e2 Â» e3

t1 d.1 â‡“ () â‹„ e1 [[:REDt1]]
t2 d.2 â‡“ v2 â‹„ e2 [[:REDt2]]
----------------------- :: PatU
t1 ; t2 d â‡“ v2 â‹„ e1 Â» e2

t d.1 â‡“ Inl v1 â‹„ e1 [[:REDt]]
u1[x1 â‰” v1] d.2 â‡“ v2 â‹„ e2 [[:REDu1sub]]
----------------------- :: PatL
t â‰»case { Inl x1 âŸ¼ u1, Inr x2 âŸ¼ u2 } d â‡“ v2 â‹„ e1 Â» e2

t d.1 â‡“ Inr v1 â‹„ e1 [[:REDt]]
u2[x2 â‰” v1] d.2 â‡“ v2 â‹„ e2 [[:REDu2sub]]
----------------------- :: PatR
t â‰»case { Inl x1 âŸ¼ u1, Inr x2 âŸ¼ u2 } d â‡“ v2 â‹„ e1 Â» e2

t d.1 â‡“ (v1,v2) â‹„ e1 [[:REDt]]
u[x1 â‰” v1][x2 â‰” v2] d.2 â‡“ v2 â‹„ e2 [[:REDusub]]
----------------------- :: PatP
t â‰»case (x1,x2) âŸ¼ u d â‡“ v2 â‹„ e1 Â» e2

% Can e1 have effect on the content of the ampar? I don't think so, but maybe
t d.1 â‡“ âŸ¨ v1 âŸ v2 âŸ© D â‹„ e1 [[:REDt]]
u[x â‰” v1] d.2 â‡“ v3 â‹„ e2 [[:REDusub]]
v2 D |e2 â¤‹ v4 D'| e3 [[:EAPPv2e2]]
---------------------------------- :: Map
t â‰»map x âŸ¼ u d â‡“ âŸ¨v3 âŸ v4âŸ© D' â‹„ e1 Â» e3

-------------------------- :: Alloc
alloc T d â‡“ âŸ¨ +dyn d âŸ -dyn d âŸ© { -dyn d : Â¹Î½ T } â‹„ Îµ

t d â‡“ v â‹„ e [[:REDt]]
----------------------------------------- :: ToA
toâ§” t d â‡“ âŸ¨ () âŸ v âŸ© {} â‹„ e

t d â‡“ âŸ¨ () âŸ v âŸ© {} â‹„ e [[:REDt]]
-------------------------------------- :: FromA
fromâ§” t d â‡“ v â‹„ e

t d â‡“ +h â‹„ e [[:REDt]]
------------------------------------- :: FillU
t â¨ () d â‡“ () â‹„ e Â» h â‰” ()

t d.1 â‡“ +h â‹„ e [[:REDt]]
--------------------------------------- :: FillL
t â¨ Inl d â‡“ +dyn d.2 â‹„ e Â» h â‰” Inl -dyn d.2

t d.1 â‡“ +h â‹„ e [[:REDt]]
--------------------------------------- :: FillR
t â¨ Inr d â‡“ +dyn d.2 â‹„ e Â» h â‰” Inr -dyn d.2

t d.1 â‡“ +h â‹„ e [[:REDt]]
--------------------------------------- :: FillP
t â¨ (,) d â‡“ ( +dyn d.2, +dyn d.3) â‹„ e Â» h â‰” (-dyn d.2,-dyn d.3)

t d.1 â‡“ +h â‹„ e1 [[:REDt]]
u d.2 â‡“ âŸ¨v1 âŸ v2âŸ© D â‹„ e2 [[:REDu]]
---------------------------------------- :: FillC
t â¨Â· u d â‡“ v1â‹„ e1 Â» e2 Â» h â‰” v2
