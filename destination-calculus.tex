\section{Destination-passing linear calculus}

\renewcommand{\d}[1]{#1^{\textrm{D}}}
\renewcommand{\to}{\triangleright}
\newcommand{\lto}{\multimap}
\newcommand{\seq}{\vdash}
\makeatletter
\def\t{\@ifstar\@t\@@t}
\def\@t#1#2{#1 : #2}
\def\@@t#1#2{#1{:}#2}
\makeatletter
\newcommand{\kw}[1]{\textsf{#1}}
\newcommand{\abu}[1]{\lambda().\,#1}
\newcommand{\ab}[3]{\lambda(\t{#1}{#2}).\,#3}
\newcommand{\abp}[5]{\lambda(\t{#1}{#2}, \t{#3}{#4}).\,#5}
\newcommand{\ap}[2]{#1~#2}
\newcommand{\alloc}[2]{\kw{alloc}_{#1}~#2}
\newcommand{\fillLeaf}[2]{\kw{fillLeaf}~#1~#2}
\newcommand{\fillVariant}[2]{\kw{fillVariant}_{#1}~#2}
\newcommand{\fillPair}[1]{\kw{fillPair}~#1}
\newcommand{\with}[2]{\kw{with}~\{1 \mapsto #1, 2 \mapsto #2\}}
\newcommand{\uncurry}[1]{\kw{uncurry}~#1}

\subsection{Calculus syntax}

% Destination = notA
\[
\begin{array}{rcl}
t, u &\coloneqq& x \\
              && () \\
              && \abu{u} \\
              && \ab{x}{T}{t} \\
              && \abp{x}{T}{y}{U}{t} \\
              && \ap{t}{u} \\
              && \alloc{T}{t} \\
              && \fillLeaf{t}{u} \\
              && \fillVariant{i}{t} \quad (i \in \{1,2\}) \\
              && \fillPair{t} \\
              && \with{t}{u} \\
\end{array}
\]

\subsection{Derived syntax}

\[
\begin{array}{lcl}
u \to t &=& \ap{t}{u} \\
t ; u &=& \ap{(\abu{u})}{t} \\
(t, u) &=& \alloc{A \otimes B}{(\ab{dp}{\d{(A \otimes B)}}{
    \ap{(\abp{dl}{\d{A}}{dr}{\d{B}}{
        \ap{
            (\abu{\fillLeaf{u}{dr}})
        }{
            \fillLeaf{t}{dl}
        }
    })}{
        (\fillPair{dp})
    }
})} \\
1.t &=& \alloc{A \oplus B}{(\ab{ds}{\d{(A \oplus B)}}
    \ap{(\ab{dl}{\d{A}}{\fillLeaf{t}{dl}})}{(\fillVariant{1}{ds})}
)} \\
2.t &=& \alloc{A \oplus B}{(\ab{ds}{\d{(A \oplus B)}}
    \ap{(\ab{dr}{\d{B}}{\fillLeaf{t}{dr}})}{(\fillVariant{2}{ds})}
)}
\end{array}
\]

\subsection{Typing rules}

\begin{prooftree}
\AxiomC{}
\RightLabel{id}
\UnaryInfC{$\t{x}{A} \seq \t{x}{A}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{}
\RightLabel{1}
\UnaryInfC{$\seq \t{()}{1}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\Gamma \seq \t{t}{A}$}
\RightLabel{$\lambda_{()~\text{ab}}$}
\UnaryInfC{$\Gamma \seq \t*{\abu{t}}{1 \lto A}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\Gamma,\ \t{x}{A} \seq \t{t}{B}$}
\RightLabel{$\lambda_{\text{ab}}$}
\UnaryInfC{$\Gamma \seq \t*{\ab{x}{A}{t}}{A \lto B}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\Gamma,\ \t{x}{A},\ \t{y}{B} \seq \t{t}{C}$}
\RightLabel{$\lambda_{(,)~\text{ab}}$}
\UnaryInfC{$\Gamma \seq \t*{\abp{x}{A}{y}{B}{t}}{(A \otimes B) \lto C}$}
\end{prooftree}

\newcommand{\List}[1]{\textrm{List}~#1}
\newcommand{\muab}[2]{\mu #1. #2}

\subsection{Example: tail-recursive map}

\[
\kw{typerec}~\List{A} = \muab{\alpha}{1 \oplus (A \otimes \alpha)}

\t*{\textrm{fillNil}}{\d{(\List{A})} \lto 1} =\\ \ab{d}{\d{(\List{A})}}{\fillVariant{1}{d} \to \ab{dl}{\d{1}}{\fillLeaf{()}{dl}}}

\t*{\textrm{fillCons}}{\d{(\List{A})} \lto (\d{A} \otimes \d{(\List{A})})} =\\ \ab{d}{\d{(\List{A})}}{
  \ab{h}{A}{
    \fillVariant{2}{d} \to \ab{d'}{\d{(A \otimes \List{A})}}{
      \fillPair{d'}
      }
    }
  }
}

\textrm{map} = \ab{f}{A \lto B}{
  \ab{l}{\List{A}}{
    \ab{d}{\d{(\List{A})}}{
      l \to \with{
        \abu{\textrm{fillNil}~d}
      }
      {
        \fillPair{d} \to \abp{dh}{\d{A}}{dt}{\d{(\List{A})}}{\textrm{fillCons}~d~(\ap{f}{x})} ; \textrm{map}~f~t~dt}
      }
    }
  }
}
\]
